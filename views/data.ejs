<div style="display: flex; min-height: 100vh;">
  <%- include('layouts/nav') %>

  <main class="container py-4 position-relative" style="flex-grow: 1;">
    <!-- Alert -->
    <% if (typeof alert !== 'undefined' && alert) { %>
      <div class="alert alert-<%= alert.type %> alert-dismissible fade show" role="alert" style="z-index:9999;">
        <%= alert.message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>
    <!-- Header -->
    <%- include('layouts/header-main') %>

    <!-- Search Bar Overlay -->
    <!-- Modern Search Bar -->
    <div class="position-absolute top-0 end-0 mt-3 me-5">
      <div class="input-group shadow-sm" style="width: 280px;">
        <span class="input-group-text bg-white border-end-0" style="border-radius: 20px 0 0 20px;">
          <i class="bi bi-search"></i>
        </span>
        <input type="text" class="form-control border-start-0" placeholder="Cari Data..." 
              style="border-radius: 0 20px 20px 0; transition: all 0.3s ease;" id="searchGlobalInput">
      </div>
    </div>


    <!-- Wilayah Tabel Users -->
    <div class="col-md-12 mt-5 mb-4">
      <div class="table-header mb-3 d-flex justify-content-between align-items-center">
        <h4 class="card-title">Data Users</h4>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalTambahUser">
          <i class="bi bi-plus"></i> Tambah
        </button>        
      </div>
      <div class="card border-primary">
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <div id="data-users" class="mb-4">
            <div class="table-responsive">
              <table class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>WA Number</th>
                    <th>Created</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <!-- Ini data dinamis -->
                  <% if (users && users.length > 0) { %>
                  <% users.forEach(user => { %>
                  <tr>
                    <td><%= user.user_id || 'N/A' %></td>
                    <td><%= user.username || 'N/A' %></td>
                    <td><%= user.email || 'N/A' %></td>
                    <td><%= user.role || 'N/A' %></td>
                    <td><%= user.wa_num || 'N/A' %></td>
                    <td><%= user.created_at || 'N/A' %></td>
                    <td>
                      <button class="btn btn-sm btn-warning">Edit</button>
                      <button class="btn btn-sm btn-danger">Hapus</button>
                    </td>
                  </tr>
                  <% }); %>
                  <% } else { %>
                  <tr>
                    <td colspan="7" class="text-center">Tidak ada data pengguna.</td>
                  </tr>
                  <% } %>
                  <!-- Contoh data statis -->
                  <!-- Tambahan data lainnya -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MOdal User -->
    <!-- Modal Tambah User -->
    <div class="modal fade" id="modalTambahUser" tabindex="-1" aria-labelledby="modalTambahUserLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form action="/user/add" method="POST" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTambahUserLabel">Tambah Data User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input type="text" name="username" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" name="password" class="form-control" id="password" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" name="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
              <label for="role" class="form-label">Role</label>
              <select name="role" id="role" class="form-select" required>
                <option value="">Pilih Role</option>
                <option value="admin">Admin</option>
                <option value="teacher">Guru</option>
                <option value="student">Murid</option>
                <option value="parent">Orang Tua</option>
                <option value="scanner">Scan Client</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="wa_num" class="form-label">WhatsApp number</label>
              <input type="text" name="wa_num" class="form-control" id="wa_num" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>


    <!-- Wilayah Tabel Guru -->
    <div class="col-md-12 mb-4">
      <div class="table-header mb-3 d-flex justify-content-between align-items-center">
        <h4 class="card-title">Data Guru</h4>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalTambahGuru">
          <i class="bi bi-plus"></i> Tambah
        </button>        
      </div>
      <div class="card border-success">
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <div id="data-teachers" class="mb-4">
            <div class="table-responsive">
              <table class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Nama</th>
                    <th>NIP</th>
                    <th>Foto</th>
                    <th>User ID</th>
                    <th>Created</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="teachersTableBody">
                  <!-- Ini data dinamis -->
                  <% if (teachers && teachers.length > 0) { %>
                    <% teachers.forEach(teacher => { %>
                    <tr>
                      <td><%= teacher.teacher_id || 'N/A' %></td>
                      <td><%= teacher.teacher_name || 'N/A' %></td>
                      <td><%= teacher.nip || 'N/A' %></td>
                      <td><%= teacher.photo_path || 'N/A' %></td>
                      <td><%= teacher.user_id || 'N/A' %></td>
                      <td><%= teacher.created_at || 'N/A' %></td>
                      <td>
                        <button class="btn btn-sm btn-warning">Edit</button>
                        <button class="btn btn-sm btn-danger">Hapus</button>
                      </td>
                    </tr>
                    <% }); %>
                    <% } else { %>
                    <tr>
                      <td colspan="7" class="text-center">Tidak ada data pengguna.</td>
                    </tr>
                    <% } %>
                  <!-- Tambahan data lainnya -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalTambahGuru" tabindex="-1" aria-labelledby="modalTambahGuruLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form action="/guru/add" method="POST" enctype="multipart/form-data" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTambahGuruLabel">Tambah Data Guru</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="teacher_name" class="form-label">Nama Guru</label>
              <input type="text" name="teacher_name" class="form-control" id="teacher_name" required>
            </div>
            <div class="mb-3">
              <label for="nip" class="form-label">NIP</label>
              <input type="text" name="nip" class="form-control" id="nip">
            </div>
            <div class="mb-3">
              <label for="teacher_photo" class="form-label">Foto (1:1)</label>
              <input type="file" name="photo" accept="image/*" class="form-control" id="teacher_photo" onchange="previewImage(event, 'previewGuru')">
              <img id="previewGuru" class="img-thumbnail mt-2" style="display:none; max-width: 150px;">
            </div>
            <div class="mb-3">
              <label for="username_guru" class="form-label">Username (Opsional)</label>
              <input type="text" name="username" class="form-control" id="username_guru">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
    

    <!-- Tambahkan Tabel lainnya -->
     <!-- Wilayah Tabel Orang Tua -->
    <div class="col-md-12 mb-4">
      <div class="table-header mb-3 d-flex justify-content-between align-items-center">
        <h4 class="card-title">Data Orang Tua</h4>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalTambahOrangTua">
          <i class="bi bi-plus"></i> Tambah
        </button>        
      </div>
      <div class="card border-warning">
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <div id="data-parents" class="mb-4">
            <div class="table-responsive">
              <table class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Nama Orang Tua</th>
                    <th>User ID</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="parentsTableBody">
                  <!-- Ini data dinamis -->
                  <% if (parents && parents.length > 0) { %>
                    <% parents.forEach(parent => { %>
                    <tr>
                      <td><%= parent.parent_id || 'N/A' %></td>
                      <td><%= parent.parent_name || 'N/A' %></td>
                      <td><%= parent.user_id || 'N/A' %></td>
                      <td><%= parent.created_at || 'N/A' %></td>
                      <td><%= parent.updated_at || 'N/A' %></td>
                      <td>
                        <button class="btn btn-sm btn-warning">Edit</button>
                        <button class="btn btn-sm btn-danger">Hapus</button>
                      </td>
                    </tr>
                    <% }); %>
                    <% } else { %>
                    <tr>
                      <td colspan="7" class="text-center">Tidak ada data pengguna.</td>
                    </tr>
                  <% } %>
                  <!-- Tambahan data lainnya -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalTambahOrangTua" tabindex="-1" aria-labelledby="modalTambahOrangTuaLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form action="/orangtua/add" method="POST" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTambahOrangTuaLabel">Tambah Data Orang Tua</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="parent_name" class="form-label">Nama Orang Tua</label>
              <input type="text" name="parent_name" class="form-control" id="parent_name" required>
            </div>
            <div class="mb-3">
              <label for="username_ot" class="form-label">Username (Opsional)</label>
              <input type="text" name="username" class="form-control" id="username_ot">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
    

    <!-- Wilayah Tabel Siswa -->
    <div class="col-md-12 mb-4">
      <div class="table-header mb-3 d-flex justify-content-between align-items-center">
        <h4 class="card-title">Data Siswa</h4>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalTambahSiswa">
          <i class="bi bi-plus"></i> Tambah
        </button>        
      </div>
      <div class="card border-info">
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <div id="data-students" class="mb-4">
            <div class="table-responsive">
              <table class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>NIS</th>
                    <th>NISN</th>
                    <th>Nama</th>
                    <th>Tanggal Lahir</th>
                    <th>Tempat Lahir</th>
                    <th>Foto</th>
                    <th>Alamat</th>
                    <th>RFID</th>
                    <th>User ID</th>
                    <th>Parent ID</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <!-- Ini data dinamis -->
                  <% if (students && students.length > 0) { %>
                    <% students.forEach(student => { %>
                    <tr>
                      <td><%= student.student_id || 'N/A' %></td>
                      <td><%= student.nis || 'N/A' %></td>
                      <td><%= student.nisn || 'N/A' %></td>
                      <td><%= student.student_name || 'N/A' %></td>
                      <td><%= student.pob || 'N/A' %></td>
                      <td><%= student.dob || 'N/A' %></td>
                      <td><%= student.photo_path || 'N/A' %></td>
                      <td><%= student.address || 'N/A' %></td>
                      <td><%= student.rfid || 'N/A' %></td>
                      <td><%= student.user_id || 'N/A' %></td>
                      <td><%= student.parent_id || 'N/A' %></td>
                      <td><%= student.created_at || 'N/A' %></td>
                      <td><%= student.updated_at || 'N/A' %></td>
                      <td>
                        <button class="btn btn-sm btn-warning">Edit</button>
                        <button class="btn btn-sm btn-danger">Hapus</button>
                      </td>
                    </tr>
                    <% }); %>
                    <% } else { %>
                    <tr>
                      <td colspan="7" class="text-center">Tidak ada data pengguna.</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalTambahSiswa" tabindex="-1" aria-labelledby="modalTambahSiswaLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form action="/siswa/add" method="POST" enctype="multipart/form-data" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTambahSiswaLabel">Tambah Data Siswa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="student_name" class="form-label">Nama Siswa</label>
              <input type="text" name="student_name" class="form-control" id="student_name" required>
            </div>
            <div class="mb-3">
              <label for="nis" class="form-label">NIS</label>
              <input type="text" name="nis" class="form-control" id="nis" required>
            </div>
            <div class="mb-3">
              <label for="nisn" class="form-label">NISN</label>
              <input type="text" name="nisn" class="form-control" id="nisn" required>
            </div>
            <div class="mb-3">
              <label for="dob" class="form-label">Tanggal Lahir</label>
              <input type="date" name="dob" class="form-control" id="dob" required>
            </div>
            <div class="mb-3">
              <label for="pob" class="form-label">Tempat Lahir</label>
              <input type="text" name="pob" class="form-control" id="pob" required>
            </div>
            <div class="mb-3">
              <label for="student_photo" class="form-label">Foto (1:1)</label>
              <input type="file" name="photo" accept="image/*" class="form-control" id="student_photo" onchange="previewImage(event, 'previewSiswa')">
              <img id="previewSiswa" class="img-thumbnail mt-2" style="display:none; max-width: 150px;">
            </div>
            <div class="mb-3">
              <label for="rfid" class="form-label">RFID (opsional)</label>
              <input type="text" name="rfid" class="form-control" id="rfid">
            </div>
            <div class="mb-3">
              <label for="username_siswa" class="form-label">Username (Opsional)</label>
              <input type="text" name="username" class="form-control" id="username_siswa">
            </div>
            <div class="mb-3">
              <label for="parent_id" class="form-label">Orang tua</label>
              <input type="text" name="parent_id" class="form-control" id="parent_id">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
    
  </main>
</div>
<script>
  function previewImage(event, previewId) {
    const input = event.target;
    const reader = new FileReader();

    reader.onload = function(){
      const img = document.getElementById(previewId);
      img.src = reader.result;
      img.style.display = 'block';
    };

    if(input.files[0]) {
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Global searchbar filter for all tables
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('searchGlobalInput');
    const tableBodies = [
      document.getElementById('usersTableBody'),
      document.getElementById('teachersTableBody'),
      document.getElementById('parentsTableBody'),
      document.getElementById('studentsTableBody')
    ];
    if (!searchInput) return;
    searchInput.addEventListener('input', function () {
      const search = this.value.toLowerCase();
      tableBodies.forEach(tableBody => {
        if (!tableBody) return;
        Array.from(tableBody.getElementsByTagName('tr')).forEach(row => {
          // Only filter data rows, not the "Tidak ada data pengguna" row
          if (row.querySelectorAll('td').length < 2) return;
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(search) ? '' : 'none';
        });
      });
    });
  });
</script>
